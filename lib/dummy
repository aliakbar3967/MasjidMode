import 'dart:convert';

void main() {
  final String encodedData = Music.encode([
    Music(id: 1, name:'sabuj',size:'18',rating:'3.5',duration:'1.2',img:'aaa',favorite:false),
    Music(id: 1, name:'sabuj',size:'18',rating:'3.5',duration:'1.2',img:'aaa',favorite:false),
    Music(id: 1, name:'sabuj',size:'18',rating:'3.5',duration:'1.2',img:'aaa',favorite:false),
  ]);

  final List<Music> decodedData = Music.decode(encodedData);

  print(decodedData[0].name);
}

class Music {
  final int id;
  final String name, size, rating, duration, img;
  bool favorite;

  Music({
    this.id,
    this.rating,
    this.size,
    this.duration,
    this.name,
    this.img,
    this.favorite,
  });

  factory Music.fromJson(Map<String, dynamic> jsonData) {
    return Music(
      id: jsonData['id'],
      rating: jsonData['rating'],
      size: jsonData['size'],
      duration: jsonData['duration'],
      name: jsonData['name'],
      img: jsonData['img'],
      favorite: false,
    );
  }

  static Map<String, dynamic> toMap(Music music) => {
        'id': music.id,
        'rating': music.rating,
        'size': music.size,
        'duration': music.duration,
        'name': music.name,
        'img': music.img,
        'favorite': music.favorite,
      };

  static String encode(List<Music> musics) => json.encode(
        musics
            .map<Map<String, dynamic>>((music) => Music.toMap(music))
            .toList(),
      );

  static List<Music> decode(String musics) =>
      (json.decode(musics) as List<dynamic>)
          .map<Music>((item) => Music.fromJson(item))
          .toList();
}

{
    id: 1,
    name: "prayer time",
    start: "1:20am",
    end: "1:40am",
    days: "{"sat","sun","mon"}",
    options: "{silent:true,airplane:false,vibrate:false,notifyme:false}",
    status:true
}




class MyApp extends StatefulWidget {
  @override
  _MyAppState createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {

  List<Schedule> __schedules;

  TimeOfDay time;
  TimeOfDay picked;

  TimeOfDay start;
  TimeOfDay end;
  bool status = true;
  final Map<String, String> daysName = {
    'sat':'satarday',
    'sun':'sunday',
    'mon':'monday',
    'thu':'thusday',
    'wed':'wednesday',
    'tue':'tuesday',
    'fri':'friday'
  };
  Map<String, bool> days = {
    'sat': true,
    'sun': false,
    'mon': false,
    'tue': false,
    'wed': false,
    'thu': false,
    'fri': false,
  };
  Map<String, bool> options = {
    'silent': true,
    'airplane': false,
    'vibrate': false,
    'notifyme':false
  };

  void _getDataL() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    
    // final String encodedData = Schedule.encode([
    //   Schedule(id: 1, name:'sabuj',favorite:false),
    //   Schedule(id: 1, name:'sabuj',favorite:false),
    //   Schedule(id: 1, name:'sabuj',favorite:false),
    // ]);
    // // String counter = _map.toString();
    // // final List<Map<String, dynamic>> counter = jsonDecode(prefs.getString('_map'));
    // // print(counter);
    // await prefs.setString('__schedule', null);
    String _getSchedule = prefs.getString('__schedule');

    // return _getSchedule;
    if(_getSchedule != null)
    {
      // List<Schedule> decodedData;
      setState(() {
        print('if==');
        __schedules = Schedule.decode(_getSchedule);
      });
      // print(decodedData[0].name);
      // return _getSchedule;
    } else {
      print('else');
    }
  }


  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    // _setData();
    // _getDataL();
    time = TimeOfDay.now();
    print(time);
  }

  
  Future<Null> selectTime(BuildContext context) async {
    picked = await showTimePicker(context: context, initialTime: time);

    if(picked != null)
    {
      setState(() {
        time = picked;
      });
    }
  }

  TimeOfDay fromString(String time) {
    int hh = 0;
    if (time.endsWith('PM')) hh = 12;
    time = time.split(' ')[0];
    return TimeOfDay(
      hour: hh + int.parse(time.split(":")[0]) % 24, // in case of a bad time format entered manually by the user
      minute: int.parse(time.split(":")[1]) % 60,
    );
  }
  

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: Scaffold(
        appBar: AppBar(
          title: const Text('Peace Time'),
        ),
        body: true ? 
        ListView(
          children: options.keys.map((String key) {
            return CheckboxListTile(
              title: Text(key),
              value: options[key],
              onChanged: (bool value) {
                setState(() {
                  print(key);
                  options[key] = value;
                });
              }
            );
          }).toList(),
        )
        // ListView(
        //   children: days.keys.map((String key) {
        //     return CheckboxListTile(
        //       title: Text(daysName[key].toString().toUpperCase()),
        //       value: days[key],
        //       onChanged: (bool value) {
        //         setState(() {
        //           print(key);
        //           days[key] = value;
        //         });
        //       }
        //     );
        //   }).toList(),
        // )
        : Builder(
          builder: (context) {
            return Center(
              child: Column(
                children: [
                  TextButton(
                    child: Text('Start service'),
                    onPressed: () async {
                      await FlutterForegroundServicePlugin
                          .startForegroundService(
                        notificationContent: NotificationContent(
                          iconName: 'ic_launcher',
                          titleText: 'Title Text',
                          color: Colors.red,
                          priority: NotificationPriority.high,
                        ),
                        notificationChannelContent: NotificationChannelContent(
                          id: 'some_id',
                          nameText: 'settings title',
                          descriptionText: 'settings description text',
                        ),
                        isStartOnBoot: true,
                      );
                    },
                  ),
                  TextButton(
                    child: Text('Stop service'),
                    onPressed: () async {
                      await FlutterForegroundServicePlugin
                          .stopForegroundService();
                    },
                  ),
                  TextButton(
                    child: Text('Is service running'),
                    onPressed: () async {
                      var isRunning = await FlutterForegroundServicePlugin
                          .isForegroundServiceRunning();
                      print(isRunning);
                      var snackbar = SnackBar(
                        content: Text('$isRunning'),
                        duration: Duration(milliseconds: 500),
                      );
                      Scaffold.of(context).showSnackBar(snackbar);
                    },
                  ),
                  TextButton(
                    child: Text('Start task'),
                    onPressed: () async {
                      await FlutterForegroundServicePlugin.startPeriodicTask(
                        periodicTaskFun: periodicTaskFun,
                        period: const Duration(minutes: 20),
                      );
                    },
                  ),
                  TextButton(
                    child: Text('Stop task'),
                    onPressed: () async {
                      await FlutterForegroundServicePlugin.stopPeriodicTask();
                    },
                  ),
                  TextButton(
                    child: Text('Check'),
                    onPressed: _getData,
                  ),
                  TextButton(
                    child: Text('Set'),
                    onPressed: _setData,
                  ),
                  TextButton(
                    child: Text('Select Time'),
                    onPressed: () {
                      selectTime(context);
                      print("Selected time = ${time.format(context)}");

                      TimeOfDay _formated = fromString(time.format(context));

                      print("Selected time = $_formated");
                    },
                  ),
                  Text("Selected time = ${time.format(context)}"),
                ],
              ),
            );
          },
        ),
      ),
    );
  }
}

_setData() async {
  final String encodedData = Schedule.encode([
    Schedule(id: 1, name:'sabuj',status:false),
    Schedule(id: 1, name:'sabuj',status:false),
    Schedule(id: 1, name:'sabuj',status:false),
  ]);

  SharedPreferences prefs = await SharedPreferences.getInstance();
  // String counter = _map.toString();
  // final List<Map<String, dynamic>> counter = jsonDecode(prefs.getString('_map'));
  // print(counter);
  await prefs.setString('__schedule', encodedData);
}

_getData() async {
  SharedPreferences prefs = await SharedPreferences.getInstance();
  
  String _getSchedule = prefs.getString('__schedule');

  // return _getSchedule;
  if(_getSchedule != null)
  {
    List<Schedule> decodedData;
    decodedData = Schedule.decode(_getSchedule);
    print(decodedData[0].name);
    // return _getSchedule;
  } else {
    print(_getSchedule);
    // return null;
  }
}

void periodicTaskFun() {
  FlutterForegroundServicePlugin.executeTask(() async {
    // this will refresh the notification content each time the task is fire
    // if you want to refresh the notification content too each time
    // so don't set a low period duretion because android isn't handling it very well
    // await FlutterForegroundServicePlugin.refreshForegroundServiceContent(
    //   notificationContent: NotificationContent(
    //     iconName: 'ic_launcher',
    //     titleText: 'Title Text',
    //     bodyText: '${DateTime.now()}',
    //     subText: 'subText',
    //     color: Colors.red,
    //   ),
    // );

    print('.....working....');
  });
}


import 'package:flutter/cupertino.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/material.dart';
import 'package:peace_time/controller/schedule_controller.dart';
import 'package:peace_time/model/schedule.dart';
import 'package:peace_time/screens/create_schedule_screen.dart';
import 'package:peace_time/screens/edit_schedule_screen.dart';
import 'package:peace_time/screens/settings_screen.dart';

class HomeScreen extends StatefulWidget {
  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  List<Schedule> schedules;

  bool loading = true;
  bool nodata = false;
  bool selectingmode = false;

  void _getSchedulesDataFromSharedPreference() async {
    setState(() {
      loading = true;
    });
    List<Schedule> results = await ScheduleController.getSchedules();
    // print(results);
    if(results == null)
    {
      setState(() {
        schedules = null;
        nodata = true;
      });
    }
    else {
      setState(() {
        schedules = results;
        loading = false;
        nodata = false;
      });
    }
  }

  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    _getSchedulesDataFromSharedPreference();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
        // appBar: AppBar(
        //   title: Text('Schedules'),
        //   actions: [
        //     IconButton(
        //       icon: Icon(Icons.settings),
        //       onPressed: () => Navigator.push(context,CupertinoPageRoute(builder: (context) => SettingsScreen()),).then((response)=>response?_getSchedulesDataFromSharedPreference():null),
        //     ),
        //   ],
        //   elevation: 0,
        // ),
        appBar: AppBar(
          leading: selectingmode
          ? IconButton(
            icon: const Icon(Icons.arrow_back),
            onPressed: () {
              setState(() {
                selectingmode = false;
                schedules.forEach((element) => element.selected = false);
              });
            },
          ) : null,
          title: Text("Schedules"),
        ),
        floatingActionButton: FloatingActionButton(
          // elevation: 0.0,
          child: new Icon(Icons.add, size: 48.0,),
          backgroundColor: Colors.blue,
          onPressed: () => Navigator.push(context,CupertinoPageRoute(builder: (context) => CreateSchduleScreen()),).then((response)=>response?_getSchedulesDataFromSharedPreference():null)
        ),
        floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
        body: loading 
        ? nodata 
        ? Center(child: Text('No Data Found!')) 
        : Center(child: CircularProgressIndicator(),) 
        : SafeArea(
          child: Column(
            children: [
              // Row(
              //   mainAxisAlignment: MainAxisAlignment.spaceBetween,
              //   children: [
              //     Text(
              //       'Schedule',
              //       style: TextStyle(
              //           fontFamily: 'avenir',
              //           fontWeight: FontWeight.w100,
              //           fontSize: 20),
              //     ),
              //     Row(
              //       children: [
              //         Icon(Icons.settings, color: Colors.black45,)
              //       ],
              //     )
              //   ],
              // ),
              // SizedBox(height: 8.0,),
              Expanded(
                child: ListView(
                  children: List.generate(schedules.length, (index) {
                    return ListTile(
                      onLongPress: () {
                        setState(() {
                          selectingmode = true;
                        });
                      },
                      onTap: () {
                        setState(() {
                          if(selectingmode) {
                            schedules[index].selected = !schedules[index].selected;
                            print(schedules[index].selected.toString());
                          }
                        });
                      },
                      selected: schedules[index].selected,
                      leading: GestureDetector(
                        behavior: HitTestBehavior.opaque,
                        onTap: () => Navigator.push(context,CupertinoPageRoute(builder: (context) => EditSchduleScreen()),).then((response)=>response?_getSchedulesDataFromSharedPreference():null),
                        child: Container(
                          margin: const EdgeInsets.only(bottom: 24),
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                                colors: [Colors.blue, Colors.blueAccent],
                                begin: Alignment.centerLeft,
                                end: Alignment.centerRight,
                              ),
                            // color: Colors.black12,
                            boxShadow: [
                                BoxShadow(
                                  color: Colors.black12,
                                  blurRadius: 8,
                                  spreadRadius: 2,
                                  offset: Offset(4, 4),
                                ),
                              ], 
                              // borderRadius: BorderRadius.all(Radius.circular(10)),
                          ),
                          child: Column(
                            children: [
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  Text("${schedules[index].name}"),
                                  Switch(
                                    value: schedules[index].status, 
                                    onChanged: (bool value) async {
                                      await ScheduleController.remove(index);
                                      _getSchedulesDataFromSharedPreference();
                                    },
                                    activeColor: Colors.white,
                                  ),
                                ],
                              ),
                              SizedBox(height: 5.0),
                              Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Text(
                                    "${schedules[index].start} - ${schedules[index].end}",
                                    style: TextStyle(
                                      fontFamily: 'avenir',
                                      fontWeight: FontWeight.w100,
                                      fontSize: 32,
                                      color: Colors.white
                                    ),
                                  ),
                                ],
                              ),
                              SizedBox(height: 5.0),
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                                children: [
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('sat'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('sun'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('mon'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('thu'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('wed'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('tue'),
                                  ),
                                  Container(
                                    // margin: const EdgeInsets.only(bottom: 32),
                                    padding: const EdgeInsets.all(4),
                                    child: Text('fri'),
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),
                      title: Text('Name: ' + schedules[index].name.toString()),
                      subtitle: Text(schedules[index].name),
                      trailing: (selectingmode)
                      ? ((schedules[index].selected)
                      ? Icon(Icons.check_box)
                      : Icon(Icons.check_box_outline_blank))
                      : null,
                    );
                  }),
                ),
              ),
              // Expanded(
              //   child: ListView.builder(
              //     // padding: const EdgeInsets.all(8),
              //     itemCount: schedules.length,
              //     itemBuilder: (BuildContext context, int index) {
              //       return GestureDetector(
              //         onTap: () => Navigator.push(context,CupertinoPageRoute(builder: (context) => EditSchduleScreen()),).then((response)=>response?_getSchedulesDataFromSharedPreference():null),
              //         child: Container(
              //           margin: const EdgeInsets.only(bottom: 24),
              //           padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              //           decoration: BoxDecoration(
              //             gradient: LinearGradient(
              //                 colors: [Colors.blue, Colors.blueAccent],
              //                 begin: Alignment.centerLeft,
              //                 end: Alignment.centerRight,
              //               ),
              //             // color: Colors.black12,
              //             boxShadow: [
              //                 BoxShadow(
              //                   color: Colors.black12,
              //                   blurRadius: 8,
              //                   spreadRadius: 2,
              //                   offset: Offset(4, 4),
              //                 ),
              //               ], 
              //               // borderRadius: BorderRadius.all(Radius.circular(10)),
              //           ),
              //           child: Column(
              //             children: [
              //               Row(
              //                 mainAxisAlignment: MainAxisAlignment.spaceBetween,
              //                 children: [
              //                   Text("${schedules[index].name}"),
              //                   Switch(
              //                     value: schedules[index].status, 
              //                     onChanged: (bool value) async {
              //                       await ScheduleController.remove(index);
              //                       _getSchedulesDataFromSharedPreference();
              //                     },
              //                     activeColor: Colors.white,
              //                   ),
              //                 ],
              //               ),
              //               SizedBox(height: 5.0),
              //               Row(
              //                 mainAxisAlignment: MainAxisAlignment.center,
              //                 children: [
              //                   Text(
              //                     "${schedules[index].start} - ${schedules[index].end}",
              //                     style: TextStyle(
              //                       fontFamily: 'avenir',
              //                       fontWeight: FontWeight.w100,
              //                       fontSize: 32,
              //                       color: Colors.white
              //                     ),
              //                   ),
              //                 ],
              //               ),
              //               SizedBox(height: 5.0),
              //               Row(
              //                 mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              //                 children: [
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('sat'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('sun'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('mon'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('thu'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('wed'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('tue'),
              //                   ),
              //                   Container(
              //                     // margin: const EdgeInsets.only(bottom: 32),
              //                     padding: const EdgeInsets.all(4),
              //                     child: Text('fri'),
              //                   ),
              //                 ],
              //               ),
              //             ],
              //           ),
              //         ),
              //       );
              //     }
              //   ),
              // ),
            ],
          ),
        ),
      );
  }
}

